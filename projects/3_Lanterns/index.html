<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sky Lantern Wishes — Color Release</title>
<style>
  :root{
    --sky1:#0a2342; --sky2:#102a52; --sky3:#1b376b; --gold:#ffcc66;
    --hill:#071933; --ink:#eaf4ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;height:100vh;overflow:hidden;
    background:radial-gradient(100% 130% at 50% 100%, var(--sky3), var(--sky2) 50%, var(--sky1));
    color:var(--ink); font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
  }
  .scene{position:relative;width:100%;height:100%;}
  /* Stars */
  .stars{position:absolute;inset:0;pointer-events:none;z-index:0}
  .star{
    position:absolute;width:2px;height:2px;border-radius:50%;
    background:#fff;opacity:.8;filter:drop-shadow(0 0 6px #fff);
    animation:twinkle var(--twDur,6s) ease-in-out infinite var(--twDelay,0s);
  }
  @keyframes twinkle{50%{opacity:.2;transform:scale(.6)}}
  /* Clouds */
  .clouds{position:absolute;inset:0;pointer-events:none;z-index:1;opacity:.2}
  .cloud{
    position:absolute;top:10vh;left:-40vw;width:40vw;height:22vh;border-radius:50%;
    background:radial-gradient(50% 50% at 50% 50%, #fff 0 30%, #0000 60%);
    filter:blur(6px); animation:cloudMove var(--cDur,90s) linear infinite;
  }
  .cloud.c2{top:18vh;opacity:.25;transform:scale(1.2);animation-duration:110s}
  .cloud.c3{top:24vh;opacity:.18;transform:scale(1.6);animation-duration:140s}
  @keyframes cloudMove{from{left:-50vw}to{left:110vw}}
  /* Hills */
  .hills{
    position:absolute;left:-10vw;right:-10vw;bottom:-6vh;height:36vh;z-index:2;pointer-events:none;
    background:
      radial-gradient(50% 50% at 20% 100%, var(--hill) 0 55%, #0000 56%),
      radial-gradient(50% 50% at 60% 100%, var(--hill) 0 55%, #0000 56%),
      radial-gradient(50% 50% at 90% 100%, var(--hill) 0 55%, #0000 56%);
    filter:blur(1px);
  }
  /* Fireflies */
  .firefly{
    position:absolute;bottom:10vh;width:6px;height:6px;border-radius:50%;
    background:radial-gradient(circle, #ffe9a6 0 40%, #0000 70%);
    box-shadow:0 0 12px 3px #ffd87a88;
    animation:fly var(--fDur,8s) ease-in-out infinite var(--fDelay,0s);
    z-index:3;opacity:.85;
  }
  @keyframes fly{
    0%{transform:translate(0,0)}
    25%{transform:translate(30px,-16px)}
    50%{transform:translate(-10px,-8px)}
    75%{transform:translate(14px,-20px)}
    100%{transform:translate(0,0)}
  }
  /* Lanterns */
  .lantern{
    position:absolute;left:50%;bottom:-20vh;transform:translate(-50%,0) scale(var(--scale,1));
    width:70px;height:100px;z-index:4;cursor:pointer;user-select:none;
    animation:rise var(--rise,28s) linear infinite, sway var(--sway,6s) ease-in-out infinite;
    filter:drop-shadow(0 10px 12px #0006);
  }
  @keyframes rise{from{transform:translate(-50%,110vh) scale(var(--scale,1))}to{transform:translate(-50%,-120vh) scale(var(--scale,1))}}
  @keyframes sway{50%{transform:translate(calc(-50% + var(--x,8px)), var(--y,0)) scale(var(--scale,1)) rotate(var(--r,2deg))}}
  .lantern::after{
    content:attr(data-note);
    position:absolute;left:50%;bottom:112%;
    transform:translateX(-50%);white-space:nowrap;max-width:46vw;overflow:hidden;text-overflow:ellipsis;
    background:#0008;color:#fff;padding:6px 10px;border-radius:10px;font-size:12px;opacity:0;pointer-events:none;
    transition:opacity .2s; backdrop-filter:blur(3px);
  }
  .lantern:hover::after{opacity:1}
  /* Fireworks */
  .fw{
    position:absolute;width:6px;height:6px;border-radius:50%;background:#fff;pointer-events:none;z-index:5;
    animation:burst .8s ease-out forwards; box-shadow:0 0 10px 3px #fff8;
  }
  @keyframes burst{
    60%{transform:translate(var(--dx,40px), var(--dy,-40px)) scale(1); opacity:1}
    100%{transform:translate(calc(var(--dx)*1.2), calc(var(--dy)*1.2)) scale(.1); opacity:0}
  }
  /* UI */
  #addBtn{
    position:fixed;right:14px;bottom:14px;z-index:9;border:0;border-radius:14px;padding:12px 14px;
    background:#ffffffdd;color:#0a2342;font-weight:700;cursor:pointer;box-shadow:0 10px 30px #0005
  }
  #hint{ position:fixed;left:12px;bottom:12px;z-index:9;font-size:12px;opacity:.75 }
  /* Dialog */
  dialog{border:0;border-radius:16px;padding:18px;box-shadow:0 20px 60px #00000044;background:#0d1f3acc;color:#eaf4ff;width:min(520px,92vw)}
  dialog::backdrop{background:#0006;backdrop-filter:blur(2px)}
  .row{display:flex;gap:10px;margin-top:10px;justify-content:flex-end}
  .row button{padding:8px 14px;border:0;border-radius:10px;cursor:pointer;background:#ffcc66;color:#1a1a1a;font-weight:700}
  .row button:first-child{background:#e5e7eb;color:#333}
  textarea{width:100%;height:140px;resize:vertical;border:1px solid #ffffff2a;border-radius:12px;background:#06142a;color:#eaf4ff;padding:10px}
  .field{display:flex;align-items:center;gap:10px;margin:10px 0}
  .field label{font-size:13px;opacity:.9}
  .field input[type="color"]{width:42px;height:28px;border:0;border-radius:6px;background:#fff;cursor:pointer}
  /* Audio gate */
  #audioGate{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;
    background:linear-gradient(#0007,#0004);backdrop-filter:blur(3px)
  }
  #audioGate button{padding:14px 18px;border-radius:14px;border:0;cursor:pointer;font-size:16px;font-weight:700;background:#ffffffde;box-shadow:0 10px 30px #0005}
</style>
</head>
<body>
  <div class="scene" id="scene">
    <div class="stars" id="stars"></div>
    <div class="clouds">
      <div class="cloud"></div>
      <div class="cloud c2"></div>
      <div class="cloud c3"></div>
    </div>
    <div class="hills"></div>
  </div>

  <button id="addBtn" title="Release a new lantern">➕ Release Lantern</button>
  <div id="hint">Tip: click a lantern to edit its wish · tap the sky for fireworks</div>

  <dialog id="editor">
    <form method="dialog" id="editorForm">
      <div style="font-weight:800;margin-bottom:8px">Your wish (140 chars)</div>
      <textarea id="msg" maxlength="140" placeholder="Type a short wish..."></textarea>

      <!-- Color picker (used only when releasing a new lantern) -->
      <div class="field" id="colorRow">
        <label for="color">Lantern color:</label>
        <input type="color" id="color" value="#ffcc66" />
      </div>

      <div class="row">
        <button value="cancel" type="button" id="cancelBtn">Cancel</button>
        <button id="saveBtn" value="default" type="submit">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Tap-to-start audio gate (WebAudio, no MP3s needed) -->
  <div id="audioGate" role="dialog" aria-modal="true">
    <button id="audioStart">Tap to enable sounds ✨</button>
  </div>

<script>
(function(){
  /* ===== DOM helpers ===== */
  const $ = s => document.querySelector(s);
  const el = (t,c)=>{ const n=document.createElement(t); if(c) n.className=c; return n; };

  const scene = $('#scene');
  const starsWrap = $('#stars');
  const dlg = $('#editor');
  const form = $('#editorForm');
  const msg = $('#msg');
  const cancelBtn = $('#cancelBtn');
  const saveBtn = $('#saveBtn');
  const addBtn = $('#addBtn');
  const colorRow = $('#colorRow');
  const colorInput = $('#color');

  /* ===== Audio (WebAudio chime & pop) ===== */
  let audioCtx = null, audioReady=false;
  function ensureAudio(){
    if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} }
  }
  function playChime(){
    if(!audioReady||!audioCtx) return;
    const now = audioCtx.currentTime;
    const freqs = [784, 988, 1175]; // G5, B5, D6
    freqs.forEach((f,i)=>{
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type='sine'; o.frequency.value=f;
      o.connect(g); g.connect(audioCtx.destination);
      const t = now + i*0.06;
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.25, t+0.03);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.35);
      o.start(t); o.stop(t+0.4);
    });
  }
  function playPop(){
    if(!audioReady||!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    const n = audioCtx.createOscillator();
    o.type='triangle'; o.frequency.value=220;
    n.type='square'; n.frequency.value=40;
    o.connect(g); n.connect(g); g.connect(audioCtx.destination);
    const t = audioCtx.currentTime;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.5,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);
    o.start(t); n.start(t);
    o.stop(t+0.14); n.stop(t+0.14);
  }
  const gate = $('#audioGate');
  $('#audioStart').addEventListener('click', ()=>{
    ensureAudio(); if(audioCtx){ audioCtx.resume && audioCtx.resume(); }
    audioReady=true; gate.remove(); playChime();
  });

  /* ===== Stars / Fireflies ===== */
  function spawnStars(count){
    for(let i=0;i<count;i++){
      const s = el('div','star');
      s.style.left = (Math.random()*100)+'vw';
      s.style.top  = (Math.random()*100)+'vh';
      s.style.setProperty('--twDur', (4+Math.random()*6)+'s');
      s.style.setProperty('--twDelay', (-Math.random()*6)+'s');
      starsWrap.appendChild(s);
    }
  }
  function spawnFireflies(count){
    for(let i=0;i<count;i++){
      const f = el('div','firefly');
      f.style.left = (Math.random()*100)+'vw';
      f.style.bottom = (4+Math.random()*18)+'vh';
      f.style.setProperty('--fDur', (6+Math.random()*6)+'s');
      f.style.setProperty('--fDelay', (-Math.random()*6)+'s');
      scene.appendChild(f);
    }
  }

  /* ===== Color helpers ===== */
  const PRESET = ['#ffcc66','#ff9f1a','#ff6b6b','#ffd1dc','#a0e7e5','#b4f8c8','#c2c1ff','#f6c3ff','#f7a9a8','#ffde59','#8be9fd','#50fa7b'];
  const choice = a => a[Math.floor(Math.random()*a.length)];
  function hexToRgb(hex){
    hex = hex.replace('#','').trim();
    if(hex.length===3){ hex = hex.split('').map(c=>c+c).join(''); }
    const num = parseInt(hex,16);
    return { r:(num>>16)&255, g:(num>>8)&255, b:num&255 };
  }
  function rgbToHex(r,g,b){
    const h = (n)=>n.toString(16).padStart(2,'0');
    return '#'+h(r)+h(g)+h(b);
  }
  // mix c1->c2 by p (0..1)
  function mixHex(c1,c2,p){
    const a = hexToRgb(c1), b = hexToRgb(c2);
    const r = Math.round(a.r*(1-p)+b.r*p);
    const g = Math.round(a.g*(1-p)+b.g*p);
    const b2 = Math.round(a.b*(1-p)+b.b*p);
    return rgbToHex(r,g,b2);
  }

  /* ===== Lanterns ===== */
  const LANTERN_COUNT = 7;
  let activeLantern = null; // null => releasing new; non-null => editing existing
  const keyNote  = id => 'lantern-note-'+id;
  const keyColor = id => 'lantern-color-'+id;
  function saveNote(id,text){ localStorage.setItem(keyNote(id), text); }
  function loadNote(id,def){ const v=localStorage.getItem(keyNote(id)); return v==null?def:v; }
  function saveColor(id,color){ localStorage.setItem(keyColor(id), color); }
  function loadColor(id,def){ const v=localStorage.getItem(keyColor(id)); return v==null?def:v; }

  function lanternSVG(id, base){
    const c0 = mixHex(base, '#ffffff', 0.35); // bright core
    const c1 = mixHex(base, '#ffffff', 0.15);
    const stroke = mixHex(base, '#ffffff', 0.50);
    const gid = 'g-'+id;
    return `
      <svg viewBox="0 0 90 120" width="100%" height="100%" aria-hidden="true">
        <defs>
          <radialGradient id="${gid}" cx="50%" cy="40%" r="60%">
            <stop offset="0%"   stop-color="${c0}" stop-opacity=".98"/>
            <stop offset="65%"  stop-color="${c1}" stop-opacity=".70"/>
            <stop offset="100%" stop-color="${base}" stop-opacity=".18"/>
          </radialGradient>
        </defs>
        <rect x="18" y="10" width="54" height="12" rx="4" fill="#5c3b1f"/>
        <path d="M18 16 Q45 2 72 16 L72 86 Q72 106 45 114 Q18 106 18 86 Z"
              fill="url(#${gid})" stroke="${stroke}" stroke-opacity=".75" />
        <rect x="22" y="84" width="46" height="10" rx="4" fill="#5c3b1f" />
        <circle cx="45" cy="62" r="8" fill="#fff2" />
        <circle cx="45" cy="67" r="4" fill="#fff7" />
        <ellipse cx="45" cy="110" rx="18" ry="6" fill="#00000030" />
      </svg>`;
  }

  function createLantern(id, note, color){
    const lan = el('div','lantern');
    lan.dataset.id = id;
    lan.dataset.note = note;
    lan.dataset.color = color;
    lan.title = note;

    // randomized path
    const scale = (0.7 + Math.random()*0.9).toFixed(2);
    const rise  = (24 + Math.random()*16).toFixed(1) + 's';
    const sway  = (4 + Math.random()*5).toFixed(1) + 's';
    const x     = (Math.random()*80 + 10).toFixed(2) + 'vw';
    const delay = (-Math.random()*parseFloat(rise)).toFixed(2)+'s';
    const driftX = (Math.random()<.5? -1:1) * (6 + Math.random()*10);
    const rot    = (Math.random()<.5? -1:1) * (1 + Math.random()*2);

    lan.style.left = x;
    lan.style.setProperty('--scale', scale);
    lan.style.setProperty('--rise', rise);
    lan.style.setProperty('--sway', sway);
    lan.style.setProperty('--x', driftX+'px');
    lan.style.setProperty('--r', rot+'deg');
    lan.style.animationDelay = `${delay}, ${delay}`;

    lan.innerHTML = lanternSVG(id, color);

    lan.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      activeLantern = lan;              // editing existing
      msg.value = lan.dataset.note || '';
      colorRow.style.display = 'none';  // color not editable for existing (per your requirement)
      try{ dlg.showModal(); }catch(e){ dlg.setAttribute('open',''); }
      playChime();
    });

    // endless night: randomize track when a rise completes
    lan.addEventListener('animationiteration', (e)=>{
      if(e.animationName==='rise'){
        const nx = (Math.random()*80 + 10).toFixed(2) + 'vw';
        const nscale = (0.7 + Math.random()*0.9).toFixed(2);
        const ndrift = (Math.random()<.5? -1:1) * (6 + Math.random()*10);
        const nrot   = (Math.random()<.5? -1:1) * (1 + Math.random()*2);
        const nrise  = (24 + Math.random()*16).toFixed(1) + 's';
        const nsway  = (4 + Math.random()*5).toFixed(1) + 's';
        lan.style.left = nx;
        lan.style.setProperty('--scale', nscale);
        lan.style.setProperty('--x', ndrift+'px');
        lan.style.setProperty('--r', nrot+'deg');
        lan.style.setProperty('--rise', nrise);
        lan.style.setProperty('--sway', nsway);
      }
    });

    scene.appendChild(lan);
    return lan;
  }

  function releaseLantern(text, color){
    const id = 'L'+Math.random().toString(36).slice(2,8);
    const note = (text && text.trim()) ? text.trim().slice(0,140) : 'A new wish ✨';
    const base = color || choice(PRESET);
    saveNote(id, note);
    saveColor(id, base);
    const lan = createLantern(id, note, base);
    playChime();
    return lan;
  }

  /* ===== Fireworks ===== */
  function firework(x, y){
    for(let i=0;i<14;i++){
      const p = el('div','fw');
      const ang = (Math.PI*2) * (i/14) + Math.random()*0.3;
      const dist = 40 + Math.random()*28;
      p.style.left = (x-3)+'px'; p.style.top = (y-3)+'px';
      p.style.setProperty('--dx', (Math.cos(ang)*dist)+'px');
      p.style.setProperty('--dy', (Math.sin(ang)*dist)+'px');
      const hue = Math.floor(Math.random()*360);
      p.style.background = `hsl(${hue} 90% 70%)`;
      p.style.boxShadow = `0 0 10px 3px hsla(${hue} 90% 70% / .8)`;
      scene.appendChild(p);
      setTimeout(()=>p.remove(), 900);
    }
    playPop();
  }

  /* ===== Dialog submit/cancel ===== */
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    if(activeLantern){
      // editing existing (message only)
      const text = (msg.value||'').trim() || 'Empty wish';
      activeLantern.dataset.note = text.slice(0,140);
      activeLantern.title = activeLantern.dataset.note;
      saveNote(activeLantern.dataset.id, activeLantern.dataset.note);
    }else{
      // releasing new with chosen color
      const text = (msg.value||'').trim();
      const color = colorInput.value || choice(PRESET);
      releaseLantern(text, color);
    }
    try{ dlg.close(); }catch(err){ dlg.removeAttribute('open'); }
  });
  cancelBtn.addEventListener('click', ()=>{
    try{ dlg.close(); }catch(err){ dlg.removeAttribute('open'); }
  });

  /* ===== Add button ===== */
  addBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    activeLantern = null;       // releasing new
    msg.value = '';
    colorRow.style.display = 'flex';
    // suggest a pleasant random preset
    colorInput.value = choice(PRESET);
    try{ dlg.showModal(); }catch(err){ dlg.setAttribute('open',''); }
  });

  /* Clicking empty sky = fireworks */
  scene.addEventListener('click', (e)=>{
    if(e.target.classList.contains('lantern')) return;
    firework(e.clientX, e.clientY);
  });

  /* ===== Bootstrap ===== */
  (function init(){
    // stars & fireflies
    spawnStars(160);
    spawnFireflies(12);
    // load previous lanterns, else seed defaults
    const keys = Object.keys(localStorage).filter(k=>k.startsWith('lantern-note-'));
    if(keys.length){
      keys.forEach(k=>{
        const id = k.replace('lantern-note-','');
        const note = localStorage.getItem(k) || 'Wish';
        const color = loadColor(id, choice(PRESET));
        createLantern(id, note, color);
      });
    }else{
      for(let j=0;j<LANTERN_COUNT;j++){
        releaseLantern('Wish #'+(j+1), choice(PRESET));
      }
    }
    // soften hint later
    setTimeout(()=>{ const h=$('#hint'); if(h) h.style.opacity=.45; }, 5000);
  })();
})();
</script>
</body>
</html>
